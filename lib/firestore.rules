rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function emailLower() {
      return lower(request.auth.token.email);
    }

    function isMember(groupId) {
      return isSignedIn()
        && exists(/databases/$(database)/documents/groups/$(groupId)/members/$(request.auth.uid))
        && get(/databases/$(database)/documents/groups/$(groupId)/members/$(request.auth.uid)).data.status == "active";
    }

    function isOwner(groupId) {
      return isMember(groupId)
        && get(/databases/$(database)/documents/groups/$(groupId)/members/$(request.auth.uid)).data.role == "owner";
    }

    // 초대 수락 가능한지 체크
    function canAcceptInvite(groupId, inviteId) {
      let invitePath = /databases/$(database)/documents/groups/$(groupId)/invites/$(inviteId);
      return isSignedIn()
        && exists(invitePath)
        && get(invitePath).data.status == "pending"
        && get(invitePath).data.expiresAt > request.time
        && get(invitePath).data.inviteeEmailLower == emailLower();
    }

    // -------------------------------
    // groups/{groupId}
    // -------------------------------
    match /groups/{groupId} {

      // group 문서 자체는 멤버만 읽기 허용
      allow read: if isMember(groupId);

      // group 생성/수정/삭제는 다음 단계(Auth 설계)에서 다룰 예정이라 제한적으로.
      // 일단: 생성은 로그인 사용자만 (MVP), 수정은 owner만
      allow create: if isSignedIn()
        && request.resource.data.createdByUid == request.auth.uid;
      allow update, delete: if isOwner(groupId);

      // -------------------------------
      // members/{uid}
      // -------------------------------
      match /members/{uid} {

        // 멤버 목록은 멤버만 읽기
        allow read: if isMember(groupId);

        // 멤버 생성:
        // - 본인(uid == request.auth.uid)만 만들 수 있음
        // - owner 생성: 그룹 생성자(createdByUid)만 가능
        // - member 생성: pending 초대(이메일 매칭, 만료 전)가 있을 때만 가능
        // - status는 active로만 생성 가능
        allow create: if isSignedIn()
          && uid == request.auth.uid
          && request.resource.data.groupId == groupId
          && request.resource.data.status == "active"
          && request.resource.data.role in ["member", "owner"]
          && (
            // owner 부트스트랩(초대 없이 그룹 생성자만 허용)
            (request.resource.data.role == "owner"
              && get(/databases/$(database)/documents/groups/$(groupId)).data.createdByUid == request.auth.uid)
            // 일반 멤버는 초대 수락 경로만 허용
            || (
              request.resource.data.role == "member"
              && exists(/databases/$(database)/documents/groups/$(groupId)/invites/$(request.resource.data.inviteId))
              && canAcceptInvite(groupId, request.resource.data.inviteId)
            )
          );

        // 멤버 수정:
        // - 본인은 displayName 같은 것만 수정 허용
        // - owner는 멤버 role/status 변경 허용(원하면)
        allow update: if isMember(groupId) && (
          (uid == request.auth.uid
            && request.resource.data.role == resource.data.role
            && request.resource.data.status == resource.data.status
            && request.resource.data.groupId == resource.data.groupId)
          || isOwner(groupId)
        );

        // 멤버 삭제는 MVP에서는 막고, "status=left"로 처리 권장
        allow delete: if false;
      }

      // -------------------------------
      // invites/{inviteId}
      // -------------------------------
      match /invites/{inviteId} {

        // 초대 목록은 owner만 읽기 (초대 받은 사람에게 전체 초대 리스트 노출 방지)
        allow read: if isOwner(groupId);

        // 초대 생성은 owner만 가능
        allow create: if isOwner(groupId)
          && request.resource.data.groupId == groupId
          && request.resource.data.status == "pending"
          && request.resource.data.inviteeEmailLower is string
          && request.resource.data.createdByUid == request.auth.uid
          && request.resource.data.expiresAt > request.time;

        // 초대 회수/만료 처리(revoked/expired)는 owner만
        allow update: if isOwner(groupId) && (
          request.resource.data.status in ["revoked", "expired"]
        );

        // 수락은 invite 문서를 "owner만 읽을 수" 있게 했기 때문에
        // invitee가 invite를 직접 읽/업데이트할 수 없어.
        // -> 그래서 수락은 아래 방식으로 처리할 것:
        //   (1) invitee는 "accept 전용 쿼리"가 필요해 보이지만 read가 막혀있음
        //   (2) 해결: read를 "invitee 본인만" 허용하는 조건을 추가
        //
        // invitee 본인 read 허용(이메일 매칭 + pending + 만료전)
        allow get: if isSignedIn()
          && resource.data.status == "pending"
          && resource.data.expiresAt > request.time
          && resource.data.inviteeEmailLower == emailLower();

        // invitee 본인 query(list)는 보안상 위험해서 MVP에서는 막고,
        // inviteId를 앱 내에서 직접 입력/공유(또는 알림/메시지)로 전달하는 식이 가장 안전.
        // 그래도 "내 초대 목록" 기능이 필요하면 list 허용을 열어야 함(추가로 설명 가능).
        allow list: if false;

        // invitee가 수락 처리 update(accepted로 변경)
        allow update: if isSignedIn()
          && resource.data.status == "pending"
          && resource.data.expiresAt > request.time
          && resource.data.inviteeEmailLower == emailLower()
          && request.resource.data.status == "accepted"
          && request.resource.data.acceptedByUid == request.auth.uid
          && request.resource.data.acceptedAt == request.time;

        allow delete: if false;
      }

      // -------------------------------
      // stores / categories / purchases
      // -------------------------------
      match /stores/{storeId} {
        allow read, create, update: if isMember(groupId);
        allow delete: if false;
      }

      match /categories/{categoryId} {
        allow read, create, update: if isMember(groupId);
        allow delete: if false;
      }

      match /purchases/{purchaseId} {
        allow read, create, update: if isMember(groupId);
        allow delete: if false;
      }
    }
  }
}
